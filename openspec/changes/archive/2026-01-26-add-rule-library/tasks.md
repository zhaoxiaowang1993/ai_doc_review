# 实施任务清单：新增规则库功能

## 第一阶段：后端基础构建 (Infrastructure & Models)
- [x] 数据库迁移方案：在现有 SQLite `app.db` 基础上，扩展 `rules` 表（新增 type, source），并创建 `document_types`, `document_subtypes`, `rule_subtype_relations` 表
- [x] 执行数据库迁移脚本
- [x] 实现基础 API：文书分类的获取与管理接口 (GET /api/v1/document-types)
- [x] 实现规则管理 API：
    - [x] POST /api/v1/rules (新建规则)
    - [x] GET /api/v1/rules (列表查询，含搜索、过滤、排序)
    - [x] PUT /api/v1/rules/{id} (编辑规则)
    - [x] DELETE /api/v1/rules/{id} (删除规则)
- [x] 编写后端单元测试，验证 ER 关系及分类级联查询

## 第二阶段：前端 UI 开发 (Frontend Components)
- [x] 新增工作台一级页签“规则库”及其路由设置 (工作台下二级页签“自定义规则库”)
- [x] 开发自定义规则库列表页面：
    - [x] 分别实现“适用规则”和“排除规则”的 Tab 切换布局
    - [x] 构建规则表格：状态点、Hover 描述、颜色等级标签、关联子类文案转换
    - [x] 实现搜索框、状态/等级/关联子类过滤组件
- [x] 开发规则新建/编辑弹窗：
    - [x] 实现“关联文书类型”的级联多选组件 (含“通用”逻辑处理)
    - [x] 实现风险等级单选、状态 Switch、文本输入框等控件

## 第三阶段：AI 引擎集成 (Integration)
> ℹ️ **说明**: 现有 API 已支持通过 `rule_ids` 参数在审核时指定自定义规则。`RulesPanel` 已修改为默认启用所有活动规则。

- [x] 审核 API 已支持通过 `rule_ids` 参数传入自定义规则
- [x] `RulesPanel` 默认启用所有活动规则（修复规则不生效问题）
- [ ] (可选) 修改 Promptflow 或执行引擎：在审核任务开始前加载对应子类的关联规则
- [ ] (可选) 实现审核逻辑：
    - [ ] 加载 `通用` 规则 + `当前子类` 规则
    - [ ] 执行 `适用规则` 检测
    - [ ] 执行 `排除规则` 过滤 (命中则置为合规)
- [ ] (可选) 联调前后端及 AI 服务，确保规则库配置实时影响审核结果

## 第四阶段：验证与验收 (Verification)
- [x] 修复后端 `subtype_ids` 关联查询
- [x] 修复前端风险等级标签颜色
- [x] 修复 `RulesPanel` 默认启用规则逻辑
- [x] 手动验证 UI 交互细节：Hover、颜色标签、级联选择器状态切换
- [x] 优化列表页：固定列宽、列顺序、溢出显示 +N、筛选逻辑
- [ ] 创建冒烟测试脚本，覆盖规则创建 -> 关联 -> 审核全流程
