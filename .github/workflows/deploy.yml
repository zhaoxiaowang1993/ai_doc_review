name: deploy

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ALIYUN_ACR_REGISTRY }}
          username: ${{ secrets.ALIYUN_ACR_USERNAME }}
          password: ${{ secrets.ALIYUN_ACR_PASSWORD }}
      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.ALIYUN_ACR_REGISTRY }}/${{ secrets.ALIYUN_ACR_NAMESPACE }}/${{ secrets.ALIYUN_ACR_REPO }}
          tags: |
            # Tag 触发：使用 Tag 名（如 v0.1.1）
            type=ref,event=tag
            # 仅 Tag 触发时打 latest 标签（正式版本）
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/') }}
            # 分支触发：将 main 分支转为 main（避免 / 符号）
            type=ref,event=branch,enable=${{ github.ref == 'refs/heads/main' }},suffix=,prefix=
            # 提交哈希：取前7位（简洁唯一）
            type=sha,format=short
      # 构建并推送多架构镜像
      - name: Build and Push
        id: build-push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64  # 适配阿里云服务器架构
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          no-cache: true  # 禁用缓存，保证镜像最新
          pull: true      # 拉取最新基础镜像

      # 构建失败时的诊断提示（通过 Annotations 显示）
      - name: Diagnose Build Failure
        if: failure() && steps.build-push.outcome == 'failure'
        run: |
          echo "::error title=Build/Push Failed::Docker build or push failed. Common causes:"
          echo "::error::1. ACR Credentials expired or incorrect (Check secrets.ALIYUN_ACR_PASSWORD)"
          echo "::error::2. Insufficient permissions (RAM user needs 'cr:PushRepository' or 'AliyunContainerRegistryFullAccess')"
          echo "::error::3. Repository does not exist (Check ALIYUN_ACR_NAMESPACE/REPO)"

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      # 解析镜像 Tag（和 build 阶段保持一致）
      - name: Resolve image tag
        id: tag
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            # Tag 触发：使用 Tag 名
            TAG="${GITHUB_REF#refs/tags/}"
          elif [[ "${GITHUB_REF}" == refs/heads/main ]]; then
            # 分支触发：使用 main
            TAG="main"
          else
            # 其他情况：使用提交哈希前7位
            TAG="${GITHUB_SHA:0:7}"
          fi
          echo "TAG=${TAG}" >> "$GITHUB_OUTPUT"
          # 输出 Tag 便于调试
          echo "Resolved tag: ${TAG}"
      # 部署到阿里云服务器（升级 ssh-action 版本 + 完善部署脚本）
      - name: Deploy to Aliyun Server
        uses: appleboy/ssh-action@master  # 升级到最新版，解决兼容性问题
        with:
          host: ${{ secrets.ALIYUN_SERVER_HOST }}
          username: ${{ secrets.ALIYUN_SERVER_USER }}
          key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}
          timeout: 300s  # 延长超时时间，适配镜像拉取
          # 服务器端执行的部署脚本（完善容错 + 对齐本地逻辑）
          script: |
            set -e  # 任意命令失败则终止脚本
            
            # 定义错误处理函数（输出 GitHub Annotation 格式）
            handle_error() {
              echo "::error title=Deploy Script Failed::Command failed at line $1"
            }
            trap 'handle_error $LINENO' ERR
            
            echo "=== Start deploying ai-doc-review ==="
            
            # 1. 登录阿里云镜像库（避免服务器登录态过期）
            echo "Step 1: Login to Aliyun ACR"
            docker login ${{ secrets.ALIYUN_ACR_REGISTRY }} -u "${{ secrets.ALIYUN_ACR_USERNAME }}" -p "${{ secrets.ALIYUN_ACR_PASSWORD }}" || {
              echo "::error title=ACR Login Failed::Failed to login to Aliyun ACR. Check credentials."
              exit 1
            }
            
            # 2. 定义镜像完整地址
            IMAGE="${{ secrets.ALIYUN_ACR_REGISTRY }}/${{ secrets.ALIYUN_ACR_NAMESPACE }}/${{ secrets.ALIYUN_ACR_REPO }}:${{ steps.tag.outputs.TAG }}"
            echo "Step 2: Pull image - ${IMAGE}"
            
            # 3. 拉取最新镜像（失败重试）
            for i in {1..3}; do
              if docker pull "$IMAGE"; then
                break
              fi
              echo "::warning title=Image Pull Retry::Pull failed, retrying ${i}/3..."
              sleep 5
            done
            # 再次检查拉取结果，确保最后一次尝试成功（因为 set -e 可能不会在循环中生效，取决于 shell）
            # 显式验证镜像是否存在
            if ! docker image inspect "$IMAGE" > /dev/null 2>&1; then
               echo "::error title=Image Pull Failed::Failed to pull image $IMAGE after 3 attempts."
               exit 1
            fi
            
            # 4. 停止并删除旧容器（容错：无容器时不报错）
            echo "Step 3: Stop and remove old container"
            docker stop ai-doc-review || true
            docker rm ai-doc-review || true
            
            # 5. 确保数据目录存在（对齐本地 Dockerfile 逻辑）
            echo "Step 4: Create data directories"
            mkdir -p /root/workspace/ai-doc-review-data/documents
            mkdir -p /root/workspace/ai-doc-review-data/mineru
            
            # 6. 检查环境变量文件
            echo "Step 5: Check environment file"
            ENV_FILE="/root/workspace/ai-doc-review/app/api/.prod.env"
            if [ -f "$ENV_FILE" ]; then
              ENV_OPT="--env-file $ENV_FILE"
              echo "Using environment file: $ENV_FILE"
            else
              echo "::warning title=Env File Missing::Environment file not found at $ENV_FILE, running without env file"
              ENV_OPT=""
            fi
            
            # 7. 启动新容器（对齐本地 Dockerfile 环境变量/工作目录）
            echo "Step 6: Start new container"
            docker run -d \
              --name ai-doc-review \
              -p 1231:1231 \
              -v /root/workspace/ai-doc-review-data:/app/app/api/app/data \
              -e PYTHONPATH=/app:/app/app \
              -e PYTHONUNBUFFERED=1 \
              $ENV_OPT \
              --restart unless-stopped \
              "$IMAGE"
            
            # 8. 验证容器启动状态
            echo "Step 7: Verify container status"
            sleep 10  # 等待容器启动
            if docker ps | grep -q ai-doc-review; then
              echo "=== Deployment succeeded! Container is running ==="
              docker ps | grep ai-doc-review
            else
              echo "::error title=Container Startup Failed::Container is not running. Check logs below:"
              docker logs ai-doc-review
              exit 1
            fi
            
            # 9. 清理未使用的镜像（释放磁盘空间）
            echo "Step 8: Clean up unused images"
            docker image prune -f
