name: deploy

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ALIYUN_ACR_REGISTRY }}
          username: ${{ secrets.ALIYUN_ACR_USERNAME }}
          password: ${{ secrets.ALIYUN_ACR_PASSWORD }}
      - id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.ALIYUN_ACR_REGISTRY }}/${{ secrets.ALIYUN_ACR_NAMESPACE }}/${{ secrets.ALIYUN_ACR_REPO }}
          tags: |
            # Tag 触发：使用 Tag 名（如 v0.1.1）
            type=ref,event=tag
            # 仅 Tag 触发时打 latest 标签（正式版本）
            type=raw,value=latest,enable=${{ startsWith(github.ref, 'refs/tags/') }}
            # 分支触发：将 main 分支转为 main（避免 / 符号）
            type=ref,event=branch,enable=${{ github.ref == 'refs/heads/main' }},suffix=,prefix=
            # 提交哈希：取前7位（简洁唯一）
            type=sha,format=short
      # 构建并推送多架构镜像
      - name: Build and Push
        id: build-push
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64  # 适配阿里云服务器架构
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          no-cache: true  # 禁用缓存，保证镜像最新
          pull: true      # 拉取最新基础镜像

      # 构建失败时的诊断提示（通过 Annotations 显示）
      - name: Diagnose Build Failure
        if: failure() && steps.build-push.outcome == 'failure'
        run: |
          echo "::error title=Build/Push Failed::Docker build or push failed. Common causes:"
          echo "::error::1. ACR Credentials expired or incorrect (Check secrets.ALIYUN_ACR_PASSWORD)"
          echo "::error::2. Insufficient permissions (RAM user needs 'cr:PushRepository' or 'AliyunContainerRegistryFullAccess')"
          echo "::error::3. Repository does not exist (Check ALIYUN_ACR_NAMESPACE/REPO)"

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      # 检出代码，确保 docker-compose.prod.yml 存在
      - uses: actions/checkout@v4

      # 解析镜像 Tag（和 build 阶段保持一致）
      - name: Resolve image tag
        id: tag
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            # Tag 触发：使用 Tag 名
            TAG="${GITHUB_REF#refs/tags/}"
          elif [[ "${GITHUB_REF}" == refs/heads/main ]]; then
            # 分支触发：使用 main
            TAG="main"
          else
            # 其他情况：使用提交哈希前7位
            TAG="${GITHUB_SHA:0:7}"
          fi
          echo "TAG=${TAG}" >> "$GITHUB_OUTPUT"
          # 输出 Tag 便于调试
          echo "Resolved tag: ${TAG}"
      # 复制配置文件到服务器
      - name: Copy config to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.ALIYUN_SERVER_HOST }}
          username: ${{ secrets.ALIYUN_SERVER_USER }}
          key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}
          source: "docker-compose.prod.yml"
          target: "/root/workspace/ai-doc-review/"

      # 部署到阿里云服务器（使用 Docker Compose）
      - name: Deploy to Aliyun Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.ALIYUN_SERVER_HOST }}
          username: ${{ secrets.ALIYUN_SERVER_USER }}
          key: ${{ secrets.ALIYUN_SSH_PRIVATE_KEY }}
          timeout: 300s
          script: |
            set -e
            
            # 定义错误处理
            handle_error() {
              echo "::error title=Deploy Script Failed::Command failed at line $1"
            }
            trap 'handle_error $LINENO' ERR
            
            echo "=== Start deploying ai-doc-review with Docker Compose ==="
            
            # 1. 登录阿里云镜像库
            echo "Step 1: Login to Aliyun ACR"
            docker login ${{ secrets.ALIYUN_ACR_REGISTRY }} -u "${{ secrets.ALIYUN_ACR_USERNAME }}" -p "${{ secrets.ALIYUN_ACR_PASSWORD }}" || {
              echo "::error title=ACR Login Failed::Failed to login to Aliyun ACR."
              exit 1
            }
            
            # 2. 设置环境变量
            export IMAGE_NAME="${{ secrets.ALIYUN_ACR_REGISTRY }}/${{ secrets.ALIYUN_ACR_NAMESPACE }}/${{ secrets.ALIYUN_ACR_REPO }}:${{ steps.tag.outputs.TAG }}"
            echo "Step 2: Setup environment"
            echo "Image: $IMAGE_NAME"
            
            WORK_DIR="/root/workspace/ai-doc-review"
             cd $WORK_DIR
             
             # 确保数据目录存在 (用户需求: /root/workspace/ai-doc-review/ai-doc-review/data)
             # 使用相对路径: ./ai-doc-review/data
             mkdir -p ai-doc-review/data/documents
             mkdir -p ai-doc-review/data/mineru
             
             # 确保 .prod.env 存在（docker-compose 需要）
             if [ ! -f "app/api/.prod.env" ]; then
                echo "::warning::app/api/.prod.env not found, creating empty one to avoid compose error"
                mkdir -p app/api
                touch app/api/.prod.env
             fi
            
            # 3. 拉取最新镜像
             echo "Step 3: Pull image"
             # 使用 -f 指定配置文件，传递 IMAGE_NAME 环境变量
             docker compose -f docker-compose.prod.yml pull
             
             # 4. 清理旧容器与启动新服务
             echo "Step 4: Cleanup and Start services"
             
             # 尝试停止并移除同名容器（解决 Conflict 问题）
             # 无论该容器是 docker run 启动的还是 compose 启动的
             if docker ps -a --format '{{.Names}}' | grep -q "^ai-doc-review$"; then
                echo "Removing existing container: ai-doc-review"
                docker rm -f ai-doc-review || true
             fi
             
             # 启动服务
             docker compose -f docker-compose.prod.yml up -d
             
             # 5. 验证服务状态
            echo "Step 5: Verify status"
            sleep 10
            if docker compose -f docker-compose.prod.yml ps | grep -q "Up"; then
              echo "=== Deployment succeeded! ==="
              docker compose -f docker-compose.prod.yml ps
            else
              echo "::error title=Deployment Failed::Service is not running properly."
              docker compose -f docker-compose.prod.yml logs --tail 50
              exit 1
            fi
            
            # 6. 清理未使用的镜像
            echo "Step 6: Clean up"
            docker image prune -f
